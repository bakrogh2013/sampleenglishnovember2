<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Class Code Gate</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.45;margin:1.25rem;}
    .card{max-width:900px;margin:0 auto;border:1px solid #ddd;border-radius:10px;padding:1rem;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    input[type=password]{padding:.5rem;border:1px solid #bbb;border-radius:6px;min-width:220px}
    button{padding:.55rem .9rem;border:1px solid #444;border-radius:6px;background:#fff;cursor:pointer}
    #msg{color:#b00020;margin:.5rem 0}
    #content{margin-top:1rem;display:none}
    iframe{width:100%;height:600px;border:0}
    .help{font-size:.9rem;color:#555}
    .small{font-size:.85rem;color:#666;margin-top:.25rem}
  </style>
</head>
<body>
  <div class="card">
    <h1 style="margin-top:.25rem">Enter class code</h1>
    <p class="help">Your teacher gave you a short code. Enter it to open todayâ€™s activity.</p>
    <div class="row">
      <input id="pw" type="password" placeholder="e.g., alpha1" aria-label="Class code">
      <button id="submit">Open</button>
    </div>
    <div id="msg" role="alert" aria-live="polite"></div>
    <p class="small">Tip: You can link directly with <code>?story=/path/to/page.html</code> or <code>?target=/path/to/page.html</code>.</p>

    <div id="content">
      <iframe id="storyFrame" src="about:blank" title="Activity"></iframe>
    </div>
  </div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const target = params.get('target') || params.get('story') || 'story1.html';
  const schoolId = params.get('schoolId') || null;
  const frame = document.getElementById('storyFrame');

  function reveal(){
    frame.src = target;
    document.getElementById('content').style.display = 'block';
    document.querySelector('.row').style.display = 'none';
    document.getElementById('msg').textContent = '';
  }

  async function openWith(code){
    const msg = document.getElementById('msg');
    msg.textContent = '';
    try{
      const r = await fetch('/api/check', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ code, schoolId })
      });
      const j = await r.json().catch(()=>({}));
      if(r.ok && j && j.ok){
        reveal();
      } else {
        msg.textContent = (j && j.msg) || 'Invalid code';
      }
    }catch(e){
      msg.textContent = 'Network error. Try again.';
    }
  }

  document.getElementById('submit').addEventListener('click', () => {
    const code = document.getElementById('pw').value.trim();
    if(code) openWith(code);
  });

  document.getElementById('pw').addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const code = document.getElementById('pw').value.trim();
      if(code) openWith(code);
    }
  });
})();
</script>
</body>
</html>
